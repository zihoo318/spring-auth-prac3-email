<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>JWT Auth Tester</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; padding: 24px; background:#f7f7f8;}
    h1 { margin: 0 0 12px; }
    h3 { margin: 0 0 12px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size: 12px; color:#374151; display:block; margin-bottom:6px; }
    input, select { padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; min-width:200px; }
    button { padding:10px 14px; border:1px solid #111827; background:#111827; color:#fff; border-radius:8px; cursor:pointer; }
    button.secondary { background:#fff; color:#111827; }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    #tokenView { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#111827; color:#e5e7eb; padding:8px 10px; border-radius:6px; display:inline-block; max-width:100%; overflow-wrap:anywhere; }
    #logs { white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b1020; color:#d1e7ff; padding:12px; border-radius:10px; min-height:200px; border:1px solid #0f172a; }
    .muted { color:#6b7280; font-size:12px; }

    .status-pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; }
    .status-ok { color:#065f46; background:#ecfdf5; border-color:#a7f3d0; }
    .status-bad { color:#b64242; background:#fef2f2; border-color:#fecaca; }

    /* 모달 팝업 */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#fff; border-radius:12px; padding:20px; width: min(420px, 90vw); box-shadow: 0 10px 30px rgba(0,0,0,.2); border:1px solid #e5e7eb; }
    .modal h4 { margin: 0 0 8px; }
    .modal p { margin: 0 0 16px; color:#374151; }
    .modal .actions { display:flex; justify-content:flex-end; gap:8px; }
  </style>
</head>
<body>
<h1>JWT Auth Tester</h1>

<!-- 상단: BASE_URL & 토큰 -->
<div class="card">
  <div class="row" style="gap:20px;">
    <div>
      <label>BASE_URL</label>
      <input id="baseUrl" value="http://localhost:8080" />
    </div>
    <div>
      <label>현재 accessToken</label>
      <div id="tokenView">없음</div>
    </div>
    <div class="row">
      <button class="secondary" onclick="clearToken()">accessToken 초기화</button>
    </div>
  </div>
</div>

<!-- 회원가입 -->
<div class="card">
  <h3>회원가입</h3>
  <div class="row">
    <div>
      <label>username</label>
      <input id="su-username" placeholder="user01" />
    </div>
    <div>
      <label>password</label>
      <input id="su-password" placeholder="pass1234" type="password" />
    </div>
    <div>
      <label>role</label>
      <select id="su-role">
        <option value="USER">USER</option>
        <option value="ADMIN">ADMIN</option>
      </select>
    </div>

    <!-- 이메일 + 인증코드 입력 -->
    <div style="display:flex; flex-direction:column;">
      <label>email</label>
      <div class="row" style="gap:8px;">
        <input id="su-email" placeholder="user01@example.com" type="email" />
        <button class="secondary" id="send-verify-btn" onclick="requestEmailCode()">코드 발송</button>
        <span id="email-status" class="status-pill status-bad">미인증</span>
      </div>
      <div class="row" style="gap:8px; margin-top:8px;">
        <input id="su-code" placeholder="인증코드 6자리" inputmode="numeric" maxlength="10" />
        <button class="secondary" id="verify-code-btn" onclick="verifyEmailCode()">코드 확인</button>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:12px;">
    <button id="signup-btn" onclick="signUp()" disabled title="이메일 인증 완료 후 회원가입 가능합니다.">/auth/sign-up</button>
  </div>
  <div class="muted" style="margin-top:8px;">
    이메일로 받은 <b>인증코드</b>를 입력해 확인이 완료되면 회원가입 버튼이 활성화됩니다.
  </div>
</div>

<!-- 로그인 -->
<div class="card">
  <h3>로그인</h3>
  <div class="row">
    <div>
      <label>username</label>
      <input id="li-username" placeholder="user01" />
    </div>
    <div>
      <label>password</label>
      <input id="li-password" placeholder="pass1234" type="password" />
    </div>
  </div>
  <div class="row" style="margin-top:12px;">
    <button onclick="login()">/auth/login</button>
    <button class="secondary" onclick="refresh()">/auth/refresh (쿠키 필요)</button>
  </div>
  <div class="muted" style="margin-top:8px;">
    access는 15초, refresh는 1분.
  </div>
</div>

<!-- 권한 테스트 -->
<div class="card">
  <h3>권한 테스트</h3>
  <div class="row">
    <button onclick="callUser()">/role/user (USER 필요)</button>
    <button onclick="callAdmin()">/role/admin (ADMIN 필요)</button>
  </div>
</div>

<!-- 로그 -->
<div class="card">
  <div class="row">
    <button class="secondary" onclick="clearLogs()">로그 지우기</button>
  </div>
  <h3>Logs</h3>
  <div id="logs"></div>
</div>

<!-- 모달 팝업 -->
<div id="modal-backdrop" class="modal-backdrop">
  <div class="modal">
    <h4 id="modal-title">알림</h4>
    <p id="modal-message">메시지</p>
    <div class="actions">
      <button class="secondary" onclick="hideModal()">닫기</button>
    </div>
  </div>
</div>

<script>
  let accessToken = null;

  // 이메일 인증 상태
  let emailVerified = false;
  let verifiedEmail = null;

  function setToken(token) {
    accessToken = token || null;
    const v = document.getElementById('tokenView');
    if (!accessToken) { v.textContent = '없음'; return; }
    const short = accessToken.length > 30
            ? accessToken.slice(0, 20) + ' ... ' + accessToken.slice(-10)
            : accessToken;
    v.textContent = short;
  }
  function clearToken() { setToken(null); log('accessToken cleared'); }

  function log(...args) {
    const el = document.getElementById('logs');
    const ts = new Date().toISOString();
    el.textContent += `[${ts}] ${args.map(a => (typeof a === 'string' ? a : JSON.stringify(a, null, 2))).join(' ')}\n`;
    el.scrollTop = el.scrollHeight;
  }
  function clearLogs() { document.getElementById('logs').textContent = ''; }

  function base() { return document.getElementById('baseUrl').value.replace(/\/+$/,''); }

  function setEmailVerified(ok, email) {
    emailVerified = !!ok;
    verifiedEmail = ok ? (email || verifiedEmail) : null;
    const pill = document.getElementById('email-status');
    const btn  = document.getElementById('signup-btn');
    pill.textContent = ok ? '인증완료' : '미인증';
    pill.classList.toggle('status-ok', ok);
    pill.classList.toggle('status-bad', !ok);
    btn.disabled = !ok;
    if (ok && email) {
      const el = document.getElementById('su-email');
      el.value = email;
      el.readOnly = true;
      el.style.background = '#f3f4f6';
    }
  }

  function resetEmailVerificationIfChanged() {
    const el = document.getElementById('su-email');
    const current = el.value.trim();
    if (!verifiedEmail || current.toLowerCase() !== verifiedEmail.toLowerCase()) {
      setEmailVerified(false, null);
    }
  }

  document.addEventListener('input', (e) => {
    if (e.target && e.target.id === 'su-email') resetEmailVerificationIfChanged();
  });

  async function req(path, { method='GET', body=null, withAuth=false, withJson=true } = {}) {
    const headers = {};
    if (withJson) headers['Content-Type'] = 'application/json';
    if (withAuth && accessToken) headers['Authorization'] = `Bearer ${accessToken}`;
    const res = await fetch(base() + path, {
      method,
      headers,
      body: body && withJson ? JSON.stringify(body) : body,
      credentials: 'include',
    });
    const ct = res.headers.get('content-type') || '';
    let data = null;
    if (ct.includes('application/json')) {
      try { data = await res.json(); } catch { data = await res.text(); }
    } else {
      data = await res.text();
    }
    log(`${method} ${path} → ${res.status}`, data);
    return { res, data };
  }

  // ===== 이메일 코드 발송 =====
  async function requestEmailCode() {
    const email = document.getElementById('su-email').value?.trim();
    if (!email) return showModal('이메일 입력', '인증코드 발송을 위해 이메일을 입력해주세요.');

    const {res, data} = await req(`/auth/email/send-code?email=${encodeURIComponent(email)}`, {
      method: 'POST',
      withJson: false
    });

    if (res.ok) {
      showModal('코드 발송 완료', '메일로 전송된 인증코드를 입력 후 "코드 확인"을 눌러주세요.');
    } else {
      const raw = typeof data === 'string' ? data : (data && data.error) || '';
      const textOnly = raw.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
      if (res.status === 400 && textOnly.includes('허용되지 않은 이메일 도메인')) {
        showModal('허용되지 않은 도메인', '해당 이메일 도메인은 허용되지 않아 인증코드를 발송할 수 없습니다.');
      } else {
        showModal('코드 발송 실패', textOnly || '인증코드 발송에 실패했습니다.');
      }
    }
  }

  // ===== 이메일 코드 확인 =====
  async function verifyEmailCode() {
    const email = document.getElementById('su-email').value?.trim();
    const code = document.getElementById('su-code').value?.trim();
    if (!email || !code) return showModal('입력 필요', '이메일과 인증코드를 모두 입력해주세요.');

    const {res, data} = await req('/auth/email/verify-code', {
      method: 'POST',
      body: {email, code}
    });

    if (res.ok) {
      setEmailVerified(true, email);
      showModal('인증 완료', '이메일 인증이 완료되었습니다. 회원가입을 진행할 수 있습니다.');
    } else {
      setEmailVerified(false, null);
      showModal('인증 실패', typeof data === 'string' ? data : '코드가 올바르지 않거나 만료되었습니다.');
    }
  }

  // ===== 회원가입 =====
  async function signUp() {
    const username = document.getElementById('su-username').value?.trim();
    const email = document.getElementById('su-email').value?.trim();
    const password = document.getElementById('su-password').value;
    const role = document.getElementById('su-role').value;

    if (!username || !email || !password) {
      return showModal('입력 필요', 'username / email / password 를 입력해주세요.');
    }
    if (!emailVerified || !verifiedEmail || email.toLowerCase() !== verifiedEmail.toLowerCase()) {
      return showModal('이메일 인증 필요', '회원가입 전, 이메일 인증을 완료해주세요.');
    }

    const {res, data} = await req('/auth/sign-up', {
      method: 'POST',
      body: {userName: username, email, password, role}
    });

    if (res.ok) {
      showModal('회원가입 완료', '회원가입이 완료되었습니다. 이제 로그인할 수 있습니다.');
    } else {
      showModal('회원가입 실패', typeof data === 'string' ? data : '회원가입에 실패했습니다.');
    }
  }

  // ===== 로그인 / 토큰 =====
  async function login() {
    const username = document.getElementById('li-username').value?.trim();
    const password = document.getElementById('li-password').value;
    if (!username || !password) return log('로그인: username/password 입력');

    const {res, data} = await req('/auth/login', {
      method: 'POST',
      body: {userName: username, password}
    });

    if (res.ok && data && data.accessToken) {
      setToken(data.accessToken);
      showModal('로그인 성공', 'accessToken이 저장되었습니다.');
    } else {
      showModal('로그인 실패', 'accessToken을 응답에서 찾지 못했습니다. LoginResponse 형식을 확인하세요.');
    }
  }

  async function refresh() {
    const {res, data} = await req('/auth/refresh', {method: 'POST'});
    if (res.ok && data && data.accessToken) {
      setToken(data.accessToken);
      showModal('토큰 갱신', '새 accessToken 저장 완료 (refresh)');
    } else {
      showModal('갱신 실패', 'refresh 응답에 accessToken이 없습니다. 서버 응답 형식 확인.');
    }
  }

  async function callUser() { await req('/role/user', {method: 'POST', withAuth: true}); }
  async function callAdmin() { await req('/role/admin', {method: 'POST', withAuth: true}); }

  // ===== 모달 =====
  function showModal(title, message) {
    document.getElementById('modal-title').textContent = title || '알림';
    document.getElementById('modal-message').textContent = message || '';
    document.getElementById('modal-backdrop').style.display = 'flex';
  }
  function hideModal() {
    document.getElementById('modal-backdrop').style.display = 'none';
  }

  // 초기화
  setToken(null);
  log('페이지 로드 완료. BASE_URL을 확인하고 테스트하세요.');

  // 전역 노출이 필요하면 아래 줄 추가
  window.hideModal = hideModal; window.showModal = showModal;
</script>
</body>
</html>
